# -*- coding: utf-8 -*-
"""BOT NOTICIAS

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Cq49ghgMYn9IIZMPH_sQhKY3gLoV1cD7
"""

!pip install feedparser requests beautifulsoup4 lxml

import feedparser
import datetime
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

GMAIL_USER = "facundo@amautainversiones.com"
GMAIL_APP_PASSWORD = "chljuizwzirvfiml"
DESTINATARIOS = ["informes@amautainversiones.com", "regina@amautainversiones.com"]

hoy = datetime.datetime.now()
hace_7_dias = hoy - datetime.timedelta(days=7)

print(f"Buscando noticias desde {hace_7_dias.strftime('%Y-%m-%d')} hasta {hoy.strftime('%Y-%m-%d')}\n")

feeds_rss = {
    "Google News - Argentina": "https://news.google.com/rss/search?q=argentina+finanzas",
    "Google News - Mercado": "https://news.google.com/rss/search?q=mercado+argentina",
    "Google News - D√≥lar": "https://news.google.com/rss/search?q=dolar+argentina",
    "Google News - Economia": "https://news.google.com/rss/search?q=economia+argentina+inflacion",
    "Reuters - Argentina": "https://www.reuters.com/rssFeed/companies/ARG",
    "Reuters - Bonos": "https://www.reuters.com/rssFeed/bondsNews",
    "Reuters - Mercados": "https://www.reuters.com/rssFeed/marketsNews",
    "BBC Mundo": "https://feeds.bbci.co.uk/mundo/rss.xml",
}

palabras_clave = [
    "argentina", "mercado", "d√≥lar", "bono", "inflaci√≥n",
    "cepo", "blue", "precio", "econom√≠a", "bcra",
    "caputo", "milei", "reforma", "ley", "impuesto",
    "reservas", "deuda", "cdi", "ted", "riesgo pa√≠s"
]

def extraer_de_rss(url_feed, nombre_fuente):
    noticias_temp = []
    try:
        feed = feedparser.parse(url_feed)
        for entry in feed.entries:
            try:
                fecha_pub = datetime.datetime(*entry.published_parsed[:6])
                if fecha_pub >= hace_7_dias:
                    titulo = entry.title.lower()
                    if any(palabra in titulo for palabra in palabras_clave):
                        noticias_temp.append({
                            'titulo': entry.title,
                            'link': entry.link,
                            'fecha': fecha_pub.strftime('%Y-%m-%d %H:%M'),
                            'fuente': nombre_fuente
                        })
            except:
                pass
    except:
        pass
    return noticias_temp

todas_noticias = []

print("üîç Buscando en fuentes RSS...")
for nombre, url in feeds_rss.items():
    noticias = extraer_de_rss(url, nombre)
    todas_noticias.extend(noticias)
    if noticias:
        print(f"  ‚úì {nombre}: {len(noticias)} noticias")

titulos_vistos = set()
noticias_unicas = []
for noticia in todas_noticias:
    if noticia['titulo'] not in titulos_vistos:
        noticias_unicas.append(noticia)
        titulos_vistos.add(noticia['titulo'])

noticias_unicas.sort(key=lambda x: x['fecha'], reverse=True)

print(f"\nüì∞ Total encontradas: {len(noticias_unicas)} noticias\n")

if noticias_unicas:
    cuerpo_html = f"""
    <html>
    <body style="font-family: Arial, sans-serif;">
        <h2>üì∞ Resumen de Noticias - Argentina & Mercados</h2>
        <p><strong>Fecha:</strong> {hoy.strftime('%d/%m/%Y %H:%M')}</p>
        <p><strong>Per√≠odo:</strong> √öltimos 7 d√≠as</p>
        <hr>
    """

    for i, noticia in enumerate(noticias_unicas[:20], 1):
        cuerpo_html += f"""
        <p>
            <strong>{i}. [{noticia['fecha']}]</strong> {noticia['titulo']}<br>
            <small>Fuente: {noticia['fuente']}</small><br>
            <a href="{noticia['link']}" target="_blank">Leer m√°s ‚Üí</a>
        </p>
        """

    cuerpo_html += """
        <hr>
        <p><small>Este resumen fue generado autom√°ticamente.</small></p>
    </body>
    </html>
    """

    try:
        mensaje = MIMEMultipart("alternative")
        mensaje["Subject"] = f"üì∞ Resumen de Noticias - {hoy.strftime('%d/%m/%Y')}"
        mensaje["From"] = GMAIL_USER
        mensaje["To"] = ", ".join(DESTINATARIOS)

        parte_html = MIMEText(cuerpo_html, "html")
        mensaje.attach(parte_html)

        servidor = smtplib.SMTP_SSL("smtp.gmail.com", 465)
        servidor.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        servidor.sendmail(GMAIL_USER, DESTINATARIOS, mensaje.as_string())
        servidor.quit()

        print("‚úÖ ¬°Email enviado exitosamente!")
        print(f"   Destinatarios: {', '.join(DESTINATARIOS)}")

    except Exception as e:
        print(f"‚ùå Error al enviar email: {e}")

else:
    print("‚ùå No se encontraron noticias para enviar.")
